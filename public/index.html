<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チャットアプリ</title>
  <style>
    .chat {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .form {
      display: flex;
      margin-top: auto; /* フォームを一番下に配置 */
    }
    .input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .submit {
      padding: 10px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }
    .user-message {
      background-color: #f0f0f0;
      border-radius: 10px;
      padding: 8px;
      margin: 8px 0;
      align-self: flex-end;
    }
    .server-message {
      background-color: #e1f7d5;
      border-radius: 10px;
      padding: 8px;
      margin: 8px 0;
      align-self: flex-start;
    }
  </style>
</head>
<body>
  <div class="chat">
    <ul class="messages"></ul>
    <form class="form">
      <input class="input" autocomplete="off" />
      <button type="submit" class="submit">送信</button>
    </form>
  </div>

  <script>
    function main() {
      const host = location.origin.replace(/^http/, 'ws');
      const ws = new WebSocket(host + '/ws');
      const myId = self.crypto.randomUUID().substr(0, 8);
      const form = document.querySelector('.form');
      const messageList = document.querySelector('.messages');

      form.onsubmit = function (e) {
        e.preventDefault();
        const input = document.querySelector('.input');
        const text = input.value.trim(); // 入力から空白をトリム
        
        if (text !== '') {
          ws.send(myId + ':' + text);
          input.value = '';
          input.focus();
        }
      }

      ws.onmessage = function (msg) {
        const response = msg.data;
        const li = document.createElement('li');
        
        // 送信者IDとメッセージテキストを抽出
        const [senderId, messageText] = response.split(':');
        
        // タイムスタンプを作成
        const timestamp = new Date().toLocaleTimeString();
        
        // 送信者IDとタイムスタンプを付加してメッセージをフォーマット
        li.textContent = `(${timestamp}) ${senderId}: ${messageText}`;
        
        // 送信者に応じてスタイルを適用
        if (senderId === myId) {
          li.classList.add('user-message');
        } else {
          li.classList.add('server-message');
        }
        
        messageList.appendChild(li);
        
        // メッセージリストを一番下までスクロール
        messageList.scrollTop = messageList.scrollHeight;
      }

      ws.onerror = function (error) {
        console.error('WebSocketエラー: ', error);
      }
    }

    main();
  </script>
</body>
</html>
